#!/usr/bin/env node

// logo
const figlet = require('figlet');
const Printer = require('@darkobits/lolcatjs');
const txt = figlet.textSync('RONNY') + "\n" + "  DIYè„šæ‰‹æ¶";
const logo = Printer.default.fromString(txt);

// æä¾›å¯è§†åŒ–é€‰æ‹©
const inquirer = require('inquirer');

// ç‰¹æ®Šå­—ä½“é¢œè‰²
const chalk = require('chalk');

// å°†JSONè½¬åŒ–ä¸ºinterface
const json2ts = require("json2ts");

// å±•ç¤ºloadingæ•ˆæœ
const ora = require('ora');

// æä¾›é«˜å…¼å®¹æ€§çš„shellå‘½ä»¤
const shell = require('shelljs');

// ä¸‹è½½gité¡¹ç›®
const download = require('download-git-repo');

// gité¡¹ç›®åœ°å€
const templateUrl = "direct:https://github.com/qiuJinLong/yd-vue-kernel.git";

// æ¥æ”¶ç”¨æˆ·è¾“å…¥
const program = require('commander');
program.version(logo, '-v, --version');  // logo + version
program.option('init', 'ğŸš€ init project');
program.option('json2ts', 'ğŸ† json to typescript interface');

// å¤„ç†ç”¨æˆ·è¾“å…¥
const bindHandler = {
  init() {
    inquirer
      // äº¤äº’æç¤º
      .prompt([
        {  // è¾“å…¥é¡¹ç›®åç§°
          type: 'text',
          message: 'ğŸ“ input project name:',
          name: 'projectName'
        },
        {  // é€‰æ‹©é¡¹ç›®è¯­è¨€
          type: 'list',
          name: 'jsKind',
          message: 'ğŸš— select language:',
          choices: ['ES6', 'TypeScript']
        },
      ])
      .then((answers) => {
        // 1. git å‡†å¤‡å¥½ä¸€ä¸ªèƒ½å®¹çº³ç™¾å·çš„é¡¹ç›®
        // 2. git ä¸‹è½½é‚£ä¸ªåŒ…
        // 3. shelljsæ ¹æ®ç”¨æˆ·é€‰æ‹©å¯¹ä½ ä¸‹è½½çš„åŒ…è¿›è¡Œä¿®æ”¹åˆ é™¤
        // 4. åœ¨ç”¨æˆ·æ¡Œé¢åˆ›å»ºæœ€ç»ˆçš„é¡¹ç›®
        // 5. å¼•å¯¼å¼€å‘ä½¿ç”¨
        const _dirname = answers.projectName;

        if (_dirname) {
          // å±•ç¤ºloadingæ•ˆæœ
          const spinner = ora('â° downloading template...');
          spinner.start();
          // é¡¹ç›®çˆ¶çº§ç›®å½•
          const _pwd = shell.pwd().stdout;
          // é¡¹ç›®ç»å¯¹è·¯å¾„
          const _projectPath = `${_pwd}/${_dirname}`;
          // è¿›å…¥çˆ¶çº§ç›®å½•
          shell.cd(_pwd);
          // åˆ é™¤æ—§é¡¹ç›®ï¼ˆå¦‚æœæœ‰ï¼‰
          shell.rm('-rf', _projectPath);
          // åˆ›å»ºæ–°é¡¹ç›®
          shell.mkdir(_dirname);
          // ä¸‹è½½ä¾èµ–cli
          download(templateUrl, _projectPath, { clone: true }, err => {
            spinner.stop();
            if (err) {
              console.log(`download error: ${err.message}`);
            } else {
              // æ›¿æ¢é¡¹ç›®åç§°
              shell.sed('-i', 'yd-vue-kernel', _dirname, _projectPath + '/package.json');
            }
          });
          /**
           * .catch(err => {
            console.log(chalk.red(`cli init error: ${err}`));
          })
           */
        }

      })
      .catch((error) => {
        if (error.isTtyError) {
          // Prompt couldn't be rendered in the current environment
        } else {
          // Something else went wrong
        }
      });
  },
  json2ts(url) {
    if (url) {
      console.log(`fetch ${url}...`);
    }

    const spinner = ora('â° generating code, please wait...')
    spinner.start();

    const jsonContent = {
      code: 200,
      info: {
        message: 'ok',
        data: [
          { num: 1, title: '3å·ä»“åº“' }
        ]
      }
    };
    const result = json2ts.convert(JSON.stringify(jsonContent));
    console.log(result);
    // spinner.stop();
  }
}

program.usage('<cmd> [env]')
  .arguments('<cmd> [env]')
  .action(function (cmd, otherParams) {
    const handler = bindHandler[cmd];
    if (handler) {
      handler(otherParams);
    } else {
      console.log(chalk.yellow('ğŸ™Sorry. No such command: ' + chalk.red(cmd)));
    }
  });

// parse user input
program.parse(process.argv);

